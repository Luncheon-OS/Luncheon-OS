#!/usr/bin/perl
use strict;
use warnings;

system "clear";

print "--== Luncheon OS Installer ==--\n";
print "/_\\ Whole-disk support only, currently.\n";

print `lsblk`;
print "==> Enter your disk's device node code: ";
my $dnCode = <>;
chomp $dnCode;

print "==> /_\\ Really proceed? This will erase YOUR WHOLE DISK. [y/n] ";
my $confirm = <>;
chomp $confirm;
exit 1 unless $confirm eq "y";

print ":: Partitioning disk...\n";
my $parted_command = "parted /dev/$dnCode --script mklabel gpt mkpart 'EFI' fat32 0% 512MiB set 1 esp on mkpart 'luncheon-os' ext4 512MiB 100%";
my $result = system $parted_command;
if ($result) {
    die "(X) Failed to partition disk...\n(X) Process killed";
}

print ":: Formatting partitions...\n";
my $dnCodeSeparator = "";
if ($dnCode =~ m/nvme/) {
    $dnCodeSeparator = "p";
}
$result = system "mkfs.fat -F 32 /dev/${dnCode}${dnCodeSeparator}1";
if ($result) {
    die "(X) Failed to format EFI partition...\n(X) Process killed";
}
$result = system "mkfs.ext4 /dev/${dnCode}${dnCodeSeparator}2";
if ($result) {
    die "(X) Failed to format Luncheon OS partition...\n(X) Process killed";
}

print ":: Mounting partitions...\n";
$result = system "mount /dev/${dnCode}${dnCodeSeparator}2 /mnt";
if ($result) {
    die "(X) Failed to mount main partition...\n(X) Process killed";
}
$result = system "mount -m /dev/${dnCode}${dnCodeSeparator}1 /mnt/boot";
if ($result) {
    die "(X) Failed to mount EFI partition...\n(X) Process killed";
}

print ":: Initializing new public Pacman keyring and populating...\n";
$result = system "pacman-key --init; pacman-key --populate archlinux";
if ($result) {
    die "(X) Failed to public Pacman keyring and/or populate...\n(X) Process killed";
}

print ":: Installing base system and Luncheon OS systems...\n";
$result = system "pacstrap /mnt base linux linux-firmware grub amd-ucode intel-ucode efibootmgr sudo";
if ($result) {
    die "(X) Failed to install systems...\n(X) Process killed";
}

print ":: Generating filesystem table...\n";
$result = system "genfstab -U /mnt >> /mnt/etc/fstab";
if ($result) {
    die "(X) Failed to generate filesystem table...\n(X) Process killed";
}

print ":: Changing root into new system...\n";
if (fork) {
    wait;
} else {
    chroot "/mnt" or die "(X) Failed to change root into new root...\n(X) Process killed";
    print "[DBG] This is where it would do chrooted setup stuff.\n";
    exit;
}

print ":: Configuring system...\n";
print "[DBG] This is where it would configure the system.\n";

print ":: Installing GRUB bootloader...\n";
print "[DBG] This is where it would install GRUB.\n";

print "[SUCCESS] Install successful! Reboot to enter Luncheon OS.\n";